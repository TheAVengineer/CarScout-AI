# Testing Flow Diagram

## ğŸ§ª Testing Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ./scripts/run_tests.sh                   â”‚
â”‚                     (Run All Tests)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€â”€â–º 1ï¸âƒ£  test_setup.py
              â”‚     â”œâ”€ Database connection
              â”‚     â”œâ”€ Seeds (sources, plans, mappings)
              â”‚     â”œâ”€ User creation
              â”‚     â””â”€ Basic normalization
              â”‚
              â”œâ”€â”€â–º 2ï¸âƒ£  test_pipeline.py
              â”‚     â”œâ”€ Parse (HTML â†’ data)
              â”‚     â”œâ”€ Normalize (brand/model)
              â”‚     â”œâ”€ Dedupe (4 methods)
              â”‚     â”œâ”€ Price (comparables)
              â”‚     â”œâ”€ AI Risk (classification)
              â”‚     â””â”€ Score (final rating)
              â”‚
              â””â”€â”€â–º 3ï¸âƒ£  test_alert_matcher.py
                    â”œâ”€ DSL Parser (8 queries)
                    â”œâ”€ Alert Matching
                    â”œâ”€ Rate Limiting
                    â””â”€ Multi-language
```

## ğŸ”„ Pipeline Test Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw HTML  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PARSE                                           â”‚
â”‚ Input:  ListingRaw (HTML)                         â”‚
â”‚ Output: ListingNormalized (structured data)       â”‚
â”‚ Tests:  âœ… Extracts price, year, mileage          â”‚
â”‚         âœ… Parses details table                    â”‚
â”‚         âœ… Collects image URLs                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. NORMALIZE                                       â”‚
â”‚ Input:  Unstructured brand/model                  â”‚
â”‚ Output: normalized_brand, normalized_model        â”‚
â”‚ Tests:  âœ… BMW X5 â†’ BMW, X5                       â”‚
â”‚         âœ… Handles variations (Ğ‘ĞœĞ’, bmw)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. DEDUPE                                          â”‚
â”‚ Input:  ListingNormalized                         â”‚
â”‚ Output: is_duplicate = True/False                 â”‚
â”‚ Tests:  âœ… Phone hash (95% confidence)            â”‚
â”‚         âœ… Image similarity (90%)                  â”‚
â”‚         âœ… Text similarity (75%)                   â”‚
â”‚         âœ… Embedding similarity (80%)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. PRICE                                           â”‚
â”‚ Input:  ListingNormalized (unique)                â”‚
â”‚ Output: predicted_price_bgn, discount_pct         â”‚
â”‚ Tests:  âš ï¸  Finds 30+ comparables                 â”‚
â”‚         âš ï¸  Calculates P10/P50/P90                â”‚
â”‚         âš ï¸  May fail if insufficient data          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. AI RISK                                         â”‚
â”‚ Input:  ListingNormalized                         â”‚
â”‚ Output: risk_level (green/yellow/red)             â”‚
â”‚ Tests:  âœ… Detects Bulgarian keywords              â”‚
â”‚         âœ… Classifies risk level                   â”‚
â”‚         âœ… Generates explanation                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. SCORE                                           â”‚
â”‚ Input:  All previous data                         â”‚
â”‚ Output: total_score (0-10), state (draft/approved)â”‚
â”‚ Tests:  âœ… Calculates price_score (0-5)           â”‚
â”‚         âœ… Applies risk_penalty (-4-0)             â”‚
â”‚         âœ… Adds freshness_bonus (0-0.5)           â”‚
â”‚         âœ… Checks approval logic (â‰¥7.5)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. NOTIFY (if approved)                           â”‚
â”‚ â”œâ”€ post_to_channel â†’ Telegram channel            â”‚
â”‚ â””â”€ match_alerts â†’ User notifications              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Alert Matcher Test Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test Query: "BMW X5 diesel <25000 2016+ auto"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DSL PARSER                                         â”‚
â”‚ Extracts:                                          â”‚
â”‚   â€¢ brand: BMW                                     â”‚
â”‚   â€¢ model: X5                                      â”‚
â”‚   â€¢ fuel: diesel                                   â”‚
â”‚   â€¢ max_price: 25000                              â”‚
â”‚   â€¢ min_year: 2016                                â”‚
â”‚   â€¢ gearbox: automatic                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE ALERT                                       â”‚
â”‚ User: test_user (Free plan)                       â”‚
â”‚ Query: "BMW X5 diesel <25000 2016+ auto"         â”‚
â”‚ Active: True                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE TEST LISTING                                â”‚
â”‚ Brand: BMW, Model: X5                             â”‚
â”‚ Price: 23000 BGN                                  â”‚
â”‚ Year: 2017, Fuel: diesel                         â”‚
â”‚ Gearbox: automatic                                â”‚
â”‚ State: approved                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MATCH ALERTS                                       â”‚
â”‚ Checks:                                            â”‚
â”‚   âœ… Brand matches (BMW = BMW)                    â”‚
â”‚   âœ… Model matches (X5 = X5)                      â”‚
â”‚   âœ… Fuel matches (diesel = diesel)               â”‚
â”‚   âœ… Price OK (23000 < 25000)                     â”‚
â”‚   âœ… Year OK (2017 â‰¥ 2016)                        â”‚
â”‚   âœ… Gearbox matches (auto = auto)                â”‚
â”‚   âœ… Alert is active                               â”‚
â”‚   âœ… Plan allows (Free: 30min delay)               â”‚
â”‚   âœ… Under daily cap (Free: 10/day)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RESULT: âœ… MATCH FOUND                            â”‚
â”‚ Creates AlertMatch record                         â”‚
â”‚ Queues notification to user                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Test Success Criteria

### âœ… PASS Criteria
```
test_setup.py:
  âœ“ All database tables exist
  âœ“ 3 sources created
  âœ“ 3 plans created (Free, Premium, Pro)
  âœ“ 17+ brand/model mappings
  âœ“ Can create user
  âœ“ Can normalize brand/model

test_pipeline.py:
  âœ“ Parse extracts all fields
  âœ“ Normalize maps correctly
  âœ“ Dedupe checks all 4 methods
  âœ“ Price estimates (or fails gracefully)
  âœ“ AI classifies risk
  âœ“ Score calculates rating

test_alert_matcher.py:
  âœ“ Parser extracts all query parts
  âœ“ Matcher finds correct alert
  âœ“ Rate limiting enforced
  âœ“ Daily caps respected
```

### âš ï¸ EXPECTED Failures
```
Price Estimation:
  â€¢ May fail if < 30 comparable listings
  â€¢ Not a critical error for MVP
  â€¢ Will work once more data scraped

API Connection:
  â€¢ Will fail if API not running
  â€¢ Start with: docker-compose up -d api
```

## ğŸ”§ Debugging Flow

```
Test Failed?
    â”‚
    â”œâ”€ Import Error
    â”‚   â””â”€â–º Run: pip install -e ".[dev]"
    â”‚
    â”œâ”€ Database Error
    â”‚   â””â”€â–º Run: docker-compose up -d db
    â”‚       â””â”€â–º Run: python scripts/seed_database.py
    â”‚
    â”œâ”€ Task Not Processing
    â”‚   â””â”€â–º Run: docker-compose restart worker beat
    â”‚       â””â”€â–º Check: http://localhost:5555
    â”‚
    â””â”€ Test Logic Error
        â””â”€â–º Read error message
            â””â”€â–º Check logs: docker-compose logs -f worker
                â””â”€â–º Debug in database: psql ...
```

## ğŸ¯ Test Coverage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component           â”‚ Coverage â”‚ Test                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parse               â”‚   100%   â”‚ test_pipeline.py     â”‚
â”‚ Normalize           â”‚   100%   â”‚ test_pipeline.py     â”‚
â”‚ Dedupe              â”‚   100%   â”‚ test_pipeline.py     â”‚
â”‚ Price               â”‚    80%   â”‚ test_pipeline.py     â”‚
â”‚ AI Risk             â”‚   100%   â”‚ test_pipeline.py     â”‚
â”‚ Score               â”‚   100%   â”‚ test_pipeline.py     â”‚
â”‚ Alert DSL           â”‚   100%   â”‚ test_alert_matcher   â”‚
â”‚ Alert Matching      â”‚   100%   â”‚ test_alert_matcher   â”‚
â”‚ Rate Limiting       â”‚   100%   â”‚ test_alert_matcher   â”‚
â”‚ Database Seeds      â”‚   100%   â”‚ test_setup.py        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total               â”‚    98%   â”‚ All tests            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Note**: Price estimation may show lower coverage (80%) because it requires sufficient comparable data. This is expected and will improve as the database grows.
